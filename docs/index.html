<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="BioHub Solutions">

<title>SG - Síndrome Gripal (SG) em Pernambuco: um painel de vigilância</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">SG</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./srag.html" rel="" target="">
 <span class="menu-text">Painel covid-19 em PE</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#objetivo" id="toc-objetivo" class="nav-link active" data-scroll-target="#objetivo"><strong>Objetivo:</strong></a></li>
  <li><a href="#carregamento-dos-pacotes" id="toc-carregamento-dos-pacotes" class="nav-link" data-scroll-target="#carregamento-dos-pacotes">Carregamento dos pacotes</a></li>
  <li><a href="#etl-extract-transform-and-load" id="toc-etl-extract-transform-and-load" class="nav-link" data-scroll-target="#etl-extract-transform-and-load">ETL (extract, transform and load)</a></li>
  <li><a href="#alimentar-nosso-banco-com-as-novas-atualizações" id="toc-alimentar-nosso-banco-com-as-novas-atualizações" class="nav-link" data-scroll-target="#alimentar-nosso-banco-com-as-novas-atualizações">Alimentar nosso banco com as novas atualizações</a></li>
  <li><a href="#criando-uma-rotina-no-r-para-executar-a-atualização-a-cada-hora" id="toc-criando-uma-rotina-no-r-para-executar-a-atualização-a-cada-hora" class="nav-link" data-scroll-target="#criando-uma-rotina-no-r-para-executar-a-atualização-a-cada-hora">Criando uma rotina no R para executar a atualização a cada hora</a></li>
  <li><a href="#dashboard-no-power-bi" id="toc-dashboard-no-power-bi" class="nav-link" data-scroll-target="#dashboard-no-power-bi">Dashboard no Power BI</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Síndrome Gripal (SG) em Pernambuco: um painel de vigilância</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>BioHub Solutions </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Última Atualização: 05-01-2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="objetivo" class="level2">
<h2 class="anchored" data-anchor-id="objetivo"><strong>Objetivo:</strong></h2>
<p>A finalidade é criar uma dashboard, com atualização automática, das notificações de síndrome gripal suspeitas de covid-19, em Pernambuco, com os dados desde 2020. Nessa dashboard, precisa constar, no mínimo, alguns indicadores: número total de notificações; média de idade das pessoas notificadas; data e hora da última notificação; número de notificações por sintomas, por condição pré-existente e por município.</p>
<p>Uma característica dos dados é que as notificações são de casos leves e suspeitos notificados pelo SUS, portanto, não reflete a totalidade dos casos de covid-19 nem o total de pessoas imunizadas. Outro ponto importante é que os casos de Síndrome Respiratória Aguda Grave (SRAG) não são contemplados nesta base de dados. Apesar disso, esse dataset serve como um bom parâmetro para monitorar a situação da covid-19 no estado.</p>
<p>Existem duas dashboards que mostram dados de covid-19 no Brasil: <a href="https://covid.saude.gov.br/">uma mais estática</a>, e outra mais <a href="https://infoms.saude.gov.br/extensions/covid-19_HTML_DIARIO/covid-19_HTML_DIARIO.html">interativa</a>, mostrando até os casos diários. No entanto, além de a atualização não ser tão frequente, os dados são pouco explorados.</p>
</section>
<section id="carregamento-dos-pacotes" class="level2">
<h2 class="anchored" data-anchor-id="carregamento-dos-pacotes">Carregamento dos pacotes</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Executar scripts do python no R</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#ETL dos dados</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DBI)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RPostgres)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#criar rotinas no R</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(taskscheduleR)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#adicionar configuracao para nao converter os eixos dos valores para notação científica</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen =</span> <span class="dv">999</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="etl-extract-transform-and-load" class="level2">
<h2 class="anchored" data-anchor-id="etl-extract-transform-and-load">ETL (extract, transform and load)</h2>
<p>Os dados foram baixados diretamente da <a href="https://datasus.saude.gov.br/notifica/">API do DataSUS</a> utilizando um script em python obtido no própio site do DataSUS com algumas modificações. as credenciais para acessar os dados via API do Elasticsearch estão disponíveis <a href="https://opendatasus.saude.gov.br/dataset/notificacoes-de-sindrome-gripal-api-elasticsearch/resource/aade6e13-0697-472b-8e5f-4f58144fe24f">neste link</a> e precisam ser adicionadas dentro dos scripts. Outra consideração importante nesse tutorial é que os diretórios para os arquivos acessados se referem a máquina onde este tutorial foi contruído. Portanto, é importante alterar esses trechos para a máquina que você utilizará.</p>
<blockquote class="blockquote">
<p>NOTA: É importante inserir sua senha de acesso ao elasticsearch (linhas 29 e 30) e colocar dentro do script (linha 44) o caminho absoluto onde será salvo o arquivo .csv com os resultados da busca.</p>
</blockquote>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source_python</span>(<span class="at">file =</span> <span class="st">"C:/Users/ronal/OneDrive/portfoglio/data_sus/SG/arquivos_de_suporte/fetch_sgpe.py"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Uma vez que a requisição à API foi concluída, realizamos algumas transformações nos dados e carregamos para um banco de dados postgreSQL utilizando o R:</p>
<blockquote class="blockquote">
<p>NOTA: alterar suas credenciais para acessar o banco de dados.</p>
</blockquote>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### carregar o arquivo CSV com a resposta da requisição ####</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>sgpe <span class="ot">=</span> <span class="fu">fread</span>(<span class="st">"C:/Users/ronal/Downloads/esus/desc-esus-notifica-estado-pe_total.csv"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#renomear os nomes das colunas</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>sgpe <span class="ot">=</span> sgpe <span class="sc">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">timestamp =</span> <span class="st">`</span><span class="at">@timestamp</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">version =</span> <span class="st">`</span><span class="at">@version</span><span class="st">`</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sgpe) <span class="ot">=</span> <span class="fu">tolower</span>(<span class="fu">names</span>(sgpe))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="do">#### criar uma conexão do R com o postgreSQL #####</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>my_user <span class="ot">=</span> <span class="st">"postgres"</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>my_password <span class="ot">=</span> <span class="st">"r&gt;python"</span> <span class="co">#coloque sua senha aqui</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="at">drv =</span> RPostgres<span class="sc">::</span><span class="fu">Postgres</span>(),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dbname=</span><span class="st">"postgres"</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">host =</span> <span class="st">"localhost"</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>                 <span class="at">port =</span> <span class="dv">5432</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">user =</span> my_user,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">password =</span> my_password)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### transformação dos dados ####</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">#criar uma chave-primária utilizando o numero da linha</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>sgpe <span class="ot">=</span> sgpe <span class="sc">%&gt;%</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">entry =</span> <span class="fu">rownames</span>(sgpe)) <span class="sc">%&gt;%</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(entry, <span class="at">.before =</span> <span class="st">"id"</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">#criar colunas com ano e mâs de notificação</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>sgpe <span class="ot">=</span> sgpe <span class="sc">%&gt;%</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ano_notif =</span> <span class="fu">as.numeric</span>(<span class="fu">substr</span>(datanotificacao, <span class="dv">1</span>, <span class="dv">4</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mes_notif =</span> <span class="fu">as.numeric</span>(<span class="fu">substr</span>(datanotificacao, <span class="dv">6</span>, <span class="dv">7</span>)))</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co">#número de dias dos sintomas até a notificação</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">interval</span>(<span class="fu">as.Date</span>(sgpe<span class="sc">$</span>datanotificacao),</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>             <span class="fu">as.Date</span>(sgpe<span class="sc">$</span>datainiciosintomas))</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>x<span class="ot">=</span> <span class="fu">abs</span>(x <span class="sc">%/%</span> <span class="fu">days</span>(<span class="dv">1</span>))</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>sgpe <span class="ot">=</span> sgpe <span class="sc">%&gt;%</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dias_ate_notif =</span> x)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="co">#número de doses</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>sgpe <span class="ot">=</span> sgpe <span class="sc">%&gt;%</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_doses =</span> <span class="fu">gsub</span>(<span class="st">'"|</span><span class="sc">\\</span><span class="st">[|</span><span class="sc">\\</span><span class="st">]|</span><span class="sc">\\</span><span class="st">|,'</span>,<span class="st">""</span>, codigodosesVacina)) <span class="sc">%&gt;%</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_doses =</span> <span class="fu">gsub</span>(<span class="st">"'| |,"</span>,<span class="st">""</span>, n_doses)) <span class="sc">%&gt;%</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n_doses =</span> <span class="fu">nchar</span>(n_doses))</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co">#avaliar se o desfecho foi covid-19</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>sgpe <span class="ot">=</span> sgpe <span class="sc">%&gt;%</span> </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">covid =</span> <span class="fu">case_when</span>(<span class="sc">!</span>classificacaofinal <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Síndrome Gripal Não Especificada"</span>,</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>                                                      <span class="st">"Descartado"</span>) <span class="sc">~</span> <span class="st">"covid"</span>,</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>                           classificacaofinal <span class="sc">==</span> <span class="st">"Síndrome Gripal Não Especificada"</span> <span class="sc">~</span> <span class="st">"SG não especificada"</span>,</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>                           classificacaofinal <span class="sc">==</span> <span class="st">"Descartado"</span> <span class="sc">~</span> <span class="st">"descartado"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">covid =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(classificacaofinal) <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="cn">NA</span>, covid))</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="co">#mudar valores vazios para NA em algumas colunas</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>sgpe <span class="ot">=</span> sgpe <span class="sc">%&gt;%</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sintomas =</span> <span class="fu">na_if</span>(sintomas,<span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">condicoes =</span> <span class="fu">na_if</span>(condicoes,<span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">racacor =</span> <span class="fu">na_if</span>(racacor,<span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ano_notif =</span> <span class="fu">na_if</span>(ano_notif, <span class="dv">2002</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">evolucaocaso =</span> <span class="fu">na_if</span>(evolucaocaso, <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sexo =</span> <span class="fu">na_if</span>(sexo,<span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">municipionotificacao =</span> <span class="fu">na_if</span>(municipionotificacao,<span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">classificacaofinal =</span> <span class="fu">na_if</span>(classificacaofinal,<span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">datanotificacao =</span> <span class="fu">if_else</span>(<span class="fu">year</span>(datanotificacao) <span class="sc">==</span> <span class="dv">2002</span>, </span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>                                   <span class="cn">NA</span> ,</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>                                   datanotificacao))</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="do">#### escrever o dataframe transformado para uma tabela no PostgreSQL ####</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> con,</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>             <span class="at">name =</span> <span class="st">"sgpe"</span>,   </span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>             <span class="at">value =</span> sgpe,</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>             <span class="at">field.types =</span> <span class="fu">c</span>(<span class="at">entry =</span> <span class="st">"SERIAL PRIMARY KEY"</span>),</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>             <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="co"># fechar a conexão</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(con)</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="alimentar-nosso-banco-com-as-novas-atualizações" class="level2">
<h2 class="anchored" data-anchor-id="alimentar-nosso-banco-com-as-novas-atualizações">Alimentar nosso banco com as novas atualizações</h2>
<p>A seguir, adaptamos os script anteriores para obter as atualizações das notificações e carregar no banco de dados. Na requisição, criamos um modo para extrair do nosso banco de dados a data e hora do último registro (variárvel ‘timestamp’) e passamos esse valor como data e hora inicial em que queremos os registros. A data e hora final é sempre o momento em que a requisição será feita.</p>
<blockquote class="blockquote">
<p>NOTA: lembre-se de alterar as credencias de acesso do elasticsearch (linhas 52 e 53), do seu banco de dados PostgreSQL (linhas 17 a 23) e caminho absoluto no script de atualização dos dados com o destino de onde o arquivo .csv será salvo (linha 70).</p>
</blockquote>
<p>Primeiro, obter as atualizações por meio de nova requisição via API:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source_python</span>(<span class="at">file =</span> <span class="st">"C:/Users/ronal/OneDrive/portfoglio/data_sus/SG/arquivos_de_suporte/update_sgpe.py"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Agora, realizar as transformações nos dados e carregar os novos registros no nosso database.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### carregar o arquivo .csv com os novos registros ####</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>to_update <span class="ot">=</span> <span class="fu">fread</span>(<span class="st">"C:/Users/ronal/Downloads/esus/desc-esus-notifica-estado-pe.csv"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#renomear os nomes das colunas</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>to_update <span class="ot">=</span> to_update <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">timestamp =</span> <span class="st">`</span><span class="at">@timestamp</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">version =</span> <span class="st">`</span><span class="at">@version</span><span class="st">`</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(to_update) <span class="ot">=</span> <span class="fu">tolower</span>(<span class="fu">names</span>(to_update))</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="do">#### criar uma conexão do R com o postgreSQL #####</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>my_user <span class="ot">=</span> <span class="st">"postgres"</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>my_password <span class="ot">=</span> <span class="st">"r&gt;python"</span> <span class="co">#coloque sua senha aqui</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(<span class="at">drv =</span> RPostgres<span class="sc">::</span><span class="fu">Postgres</span>(),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dbname=</span><span class="st">"postgres"</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">host =</span> <span class="st">"localhost"</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                 <span class="at">port =</span> <span class="dv">5432</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">user =</span> my_user,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">password =</span> my_password)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="do">#### verificar se as novas entradas já estão presentes no database ####</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">=</span> <span class="fu">paste0</span>(to_update<span class="sc">$</span>id, <span class="at">collapse =</span> <span class="st">"','"</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>query <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"SELECT * FROM sgpe WHERE id IN ('"</span>, ids, <span class="st">"');"</span>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">dbGetQuery</span>(con, query)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> result <span class="sc">%&gt;%</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(registroatual <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co">#eliminar das atualizações, as entradas já existentes</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>to_update <span class="ot">=</span> to_update <span class="sc">%&gt;%</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(registroatual <span class="sc">==</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>id <span class="sc">%in%</span> result<span class="sc">$</span>id)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="do">#### transformação dos dados e carregamento no nosso database ####</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="co">#avaliar se precisa atualizar</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(to_update) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">#descobrir a última chave primária cadastrada no banco</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  query <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"SELECT MAX(entry) FROM sgpe;"</span>)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">=</span> <span class="fu">dbGetQuery</span>(con, query)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">#adicionando a chave primária e novas colunas</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>  to_update <span class="ot">=</span> to_update <span class="sc">%&gt;%</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">entry =</span> <span class="fu">seq</span>(result<span class="sc">$</span>max<span class="sc">+</span><span class="dv">1</span>, </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>                       result<span class="sc">$</span>max<span class="sc">+</span><span class="dv">1</span><span class="sc">+</span><span class="fu">nrow</span>(to_update)<span class="sc">-</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(entry, <span class="at">.before =</span> <span class="st">"id"</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  to_update <span class="ot">=</span> to_update <span class="sc">%&gt;%</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ano_notif =</span> <span class="fu">as.numeric</span>(<span class="fu">substr</span>(datanotificacao, <span class="dv">1</span>, <span class="dv">4</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mes_notif =</span> <span class="fu">as.numeric</span>(<span class="fu">substr</span>(datanotificacao, <span class="dv">6</span>, <span class="dv">7</span>)))</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  <span class="co">#número de dias dos sintomas até a notificação</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">=</span> <span class="fu">interval</span>(<span class="fu">as.Date</span>(to_update<span class="sc">$</span>datanotificacao),</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>               <span class="fu">as.Date</span>(to_update<span class="sc">$</span>datainiciosintomas))</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>  x<span class="ot">=</span> <span class="fu">abs</span>(x <span class="sc">%/%</span> <span class="fu">days</span>(<span class="dv">1</span>))</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  to_update <span class="ot">=</span> to_update <span class="sc">%&gt;%</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dias_ate_notif =</span> x)</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(x)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  <span class="co">#número de doses</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>  to_update <span class="ot">=</span> to_update <span class="sc">%&gt;%</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_doses =</span> <span class="fu">gsub</span>(<span class="st">'"|</span><span class="sc">\\</span><span class="st">[|</span><span class="sc">\\</span><span class="st">]|</span><span class="sc">\\</span><span class="st">|,'</span>,<span class="st">""</span>, codigodosesvacina)) <span class="sc">%&gt;%</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_doses =</span> <span class="fu">gsub</span>(<span class="st">"'| |,"</span>,<span class="st">""</span>, n_doses)) <span class="sc">%&gt;%</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_doses =</span> <span class="fu">nchar</span>(n_doses))</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">#avaliar se o desfecho foi covid-19</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  to_update <span class="ot">=</span> to_update <span class="sc">%&gt;%</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">covid =</span> <span class="fu">case_when</span>(<span class="sc">!</span>classificacaofinal <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Síndrome Gripal Não Especificada"</span>,</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>                                                        <span class="st">"Descartado"</span>) <span class="sc">~</span> <span class="st">"covid"</span>,</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>                             classificacaofinal <span class="sc">==</span> <span class="st">"Síndrome Gripal Não Especificada"</span> <span class="sc">~</span> <span class="st">"SG não especificada"</span>,</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>                             classificacaofinal <span class="sc">==</span> <span class="st">"Descartado"</span> <span class="sc">~</span> <span class="st">"descartado"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">covid =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(classificacaofinal) <span class="sc">==</span> <span class="cn">TRUE</span>, <span class="cn">NA</span>, covid))</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mudar valores vazios para NA</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>  to_update <span class="ot">=</span> to_update <span class="sc">%&gt;%</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sintomas =</span> <span class="fu">if_else</span>(sintomas <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA</span>, sintomas)) <span class="sc">%&gt;%</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">condicoes =</span> <span class="fu">if_else</span>(condicoes <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA</span>, condicoes)) <span class="sc">%&gt;%</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">racacor =</span> <span class="fu">if_else</span>(racacor <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA</span>, racacor)) <span class="sc">%&gt;%</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ano_notif =</span> <span class="fu">na_if</span>(ano_notif, <span class="dv">2002</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">evolucaocaso =</span> <span class="fu">if_else</span>(evolucaocaso <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA</span>, evolucaocaso)) <span class="sc">%&gt;%</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">sexo =</span> <span class="fu">if_else</span>(sexo <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA</span>, sexo)) <span class="sc">%&gt;%</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">municipionotificacao =</span> <span class="fu">if_else</span>(municipionotificacao <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA</span>, municipionotificacao)) <span class="sc">%&gt;%</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">classificacaofinal =</span> <span class="fu">if_else</span>(classificacaofinal <span class="sc">==</span> <span class="st">""</span>, <span class="cn">NA</span>, classificacaofinal)) <span class="sc">%&gt;%</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">datanotificacao =</span> <span class="fu">if_else</span>(<span class="fu">year</span>(datanotificacao) <span class="sc">==</span> <span class="dv">2002</span>, </span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>                                     <span class="cn">NA</span> ,</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>                                     datanotificacao))</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>  <span class="co">#carregar o dataframe para nossa tabela no PostgreSQL</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbWriteTable</span>(<span class="at">conn =</span> con,</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>               <span class="at">name =</span> <span class="st">"sgpe"</span>,   </span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>               <span class="at">value =</span> to_update,</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>               <span class="at">append =</span> <span class="cn">TRUE</span>, </span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>               <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">#encerrar a conexão</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con)</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(con) </span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>  <span class="co">#encerrar a conexão</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbDisconnect</span>(con)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(con) </span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">"não precisa atualizar!"</span>)</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="criando-uma-rotina-no-r-para-executar-a-atualização-a-cada-hora" class="level2">
<h2 class="anchored" data-anchor-id="criando-uma-rotina-no-r-para-executar-a-atualização-a-cada-hora">Criando uma rotina no R para executar a atualização a cada hora</h2>
<p>Como a atualização nas notificações é feita de modo contínuo, criamos uma rotina para excutar o script python para baixar as novas notificações e o script R para tratar os dados e carregar no database. Utilizamos o pacote ‘taskscheduleR’. Vale salientar que esse pacote funciona apenas para agendamento de tarefas no Windows. Para MacOS e Linux, é necessário utlizar o pacote ‘cronR’. <a href="https://anderfernandez.com/en/blog/how-to-automate-r-scripts-on-windows-and-mac/">Este tutorial</a> é bastante útil sobre como usar esse pacotes.</p>
<blockquote class="blockquote">
<p>NOTA: é importante utilizar os caminhos absolutos dos arquivo python de atualização dos registros e do arquivo .csv onde a requisição à API será salva.</p>
</blockquote>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>script <span class="ot">=</span> <span class="st">"C:/Users/ronal/OneDrive/portfoglio/data_sus/SG/arquivos_de_suporte/transfer_to_db.R"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">taskscheduler_create</span>(<span class="at">taskname  =</span> <span class="st">"atualizar_sgpe"</span>, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">rscript   =</span> script,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">schedule  =</span> <span class="st">"HOURLY"</span>, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">starttime =</span> <span class="st">"08:50"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#para apagar a rotina</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#taskscheduler_delete(taskname = "atualizar_sgpe")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Para confirmar que a automação está funcionando, basta realizarmos a busca pela variável ‘entry’ mais recente dentro do pgAdmin:</p>
<div id="prints-pgadmin" class="quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-surus" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="arquivos_de_suporte/Picture1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Antes</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-hanno" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="arquivos_de_suporte/Picture2.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Depois</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="dashboard-no-power-bi" class="level2">
<h2 class="anchored" data-anchor-id="dashboard-no-power-bi">Dashboard no Power BI</h2>

<iframe title="Report Section" width="800" height="486" src="https://app.powerbi.com/view?r=eyJrIjoiMzUzNWE5ZDUtZWFhZC00NjkzLWJiOWQtNGQ0MWM3OTU5YmVlIiwidCI6ImRlMzE1NjI5LWUzZDItNGY4MC1iM2U0LWY2MjJiZWQ3ZmRmYyJ9" frameborder="0" allowfullscreen="true"></iframe>
<p>Algumas limitações:</p>
<ul>
<li><p>Nesta versão do report, estou rodando no meu próprio computador. Em breve, irei mover o database para o Azure ou algum outro servidor;</p></li>
<li><p>Como a conexão será <em>on premise</em>, é necessário baixar e configurar um <a href="https://powerbi.microsoft.com/pt-br/gateway/">gateway</a> para que o Power BI se comunique com a máquina. Eu utilizei o gateway do modo padrão.</p></li>
<li><p>Para máquinas em que o database está no Windows (meu caso, atualmente), é necessário que o postgreSQL esteja instalado com o driver <a href="https://github.com/npgsql/npgsql/releases/tag/v4.0.10">npsql 4.0.10</a>, ou superior, para que o Power BI se comunique com o database.</p></li>
<li><p>Nossa licença atual do Powe BI (Pro) só permite até oito atualizações diárias dos dados. Assim, apesar do banco de dados ser atualizado de hora em hora, as alterações só serão visíveis no Power BI a cada três horas, contando a partir da meia-noite.</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>